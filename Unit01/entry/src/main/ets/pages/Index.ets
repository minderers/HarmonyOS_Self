import { CourseCard } from '../components/CourseCard'
import Course from '../model/Course'

@Entry
@Component
struct Index {
  @State selectedDay: number = 1
  @State courses: Course[] = [
    new Course('1', 'é«˜ç­‰æ•°å­¦', 'å¼ æ•™æŽˆ', 'A101', 1, '08:00', '09:40'),
    new Course('2', 'å¤§å­¦ç‰©ç†', 'æŽæ•™æŽˆ', 'B203', 1, '10:00', '11:40'),
    new Course('3', 'ç¨‹åºè®¾è®¡', 'çŽ‹æ•™æŽˆ', 'C305', 2, '14:00', '15:40'),
    new Course('4', 'è‹±è¯­', 'åˆ˜æ•™æŽˆ', 'D401', 3, '08:00', '09:40'),
    new Course('5', 'æ•°æ®ç»“æž„', 'é™ˆæ•™æŽˆ', 'E501', 4, '10:00', '11:40'),
    new Course('6', 'æ“ä½œç³»ç»Ÿ', 'èµµæ•™æŽˆ', 'F601', 5, '14:00', '15:40'),
    // æ·»åŠ å‘¨æ—¥è¯¾ç¨‹
    new Course('7', 'ä½“è‚²', 'å­™æ•™æŽˆ', 'G701', 7, '09:00', '10:40'),
  ]

  // èŽ·å–å½“å‰é€‰ä¸­æ—¥æœŸçš„è¯¾ç¨‹æ•°é‡
  getSelectedDayCourseCount(): number {
    return this.courses.filter(course => course.day === this.selectedDay).length
  }
  
  // ä¿®æ­£ä»Šæ—¥è¯¾ç¨‹æ•°é‡è®¡ç®—
  getTodayCourseCount(): number {
    let today = new Date().getDay() // 0-6
    // è½¬æ¢ä¸º1-7æ ¼å¼ï¼šå‘¨æ—¥(0)è½¬ä¸º7ï¼Œå…¶ä»–+1
    today = today === 0 ? 7 : today
    return this.courses.filter(course => course.day === today).length
  }

  // èŽ·å–æ”¶è—è¯¾ç¨‹æ•°é‡ï¼ˆè¿™é‡Œå‡è®¾æ‰€æœ‰è¯¾ç¨‹éƒ½å¯èƒ½è¢«æ”¶è—ï¼‰
  getFavoriteCourseCount(): number {
    return 0 // æš‚æ—¶è¿”å›ž0ï¼Œå¯ä»¥åŽç»­æ·»åŠ æ”¶è—åŠŸèƒ½
  }

  // èŽ·å–æ€»å­¦ä¹ æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
  getSelectedDayTotalMinutes(): number {
    const selectedCourses = this.courses.filter(course => course.day === this.selectedDay)
    let totalMinutes = 0
    
    selectedCourses.forEach(course => {
      // è®¡ç®—æ¯é—¨è¯¾çš„æ—¶é•¿
      const startTime = course.startTime.split(':')
      const endTime = course.endTime.split(':')
      const startMinutes = parseInt(startTime[0]) * 60 + parseInt(startTime[1])
      const endMinutes = parseInt(endTime[0]) * 60 + parseInt(endTime[1])
      totalMinutes += (endMinutes - startMinutes)
    })
    
    return totalMinutes
  }

  // èŽ·å–æ˜ŸæœŸåç§°
  getDayName(day: number): string {
    const dayNames = ['', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥']
    return dayNames[day]
  }

  @Builder TabBuilder(day: number, text: string) {
    Column() {
      Text(text)
        .fontColor(this.selectedDay === day ? '#FFFFFF' : '#666666')
        .fontSize(14)
        .fontWeight(this.selectedDay === day ? FontWeight.Bold : FontWeight.Regular)
    }
    .width(50)
    .height(40)
    .backgroundColor(this.selectedDay === day ? '#007AFF' : 'transparent')
    .borderRadius(20)
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.selectedDay = day
    })
  }

  @Builder StatCard(title: string, count: number, color: string) {
    Column() {
      Text(count.toString())
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)
      Text(title)
        .fontSize(12)
        .fontColor('#999999')
        .margin({ top: 4 })
    }
    .justifyContent(FlexAlign.Center)
  }

  @Builder EmptyState() {
    Column() {
      Text('ðŸ“š')
        .fontSize(60)
        .margin({ bottom: 16 })
      Text(`${this.getDayName(this.selectedDay)}æ²¡æœ‰è¯¾ç¨‹å®‰æŽ’`)
        .fontSize(16)
        .fontColor('#666666')
        .margin({ bottom: 8 })
      Text('äº«å—è½»æ¾çš„ä¸€å¤©å§ï¼')
        .fontSize(14)
        .fontColor('#999999')
    }
    .justifyContent(FlexAlign.Center)
    .height('60%')
  }

  @Builder CourseCard(course: Course) {
    Column() {
      Row() {
        Column() {
          Text(course.name)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 4 })
          Text(`${course.teacher} Â· ${course.location}`)
            .fontSize(14)
            .fontColor('#666666')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        
        Text(course.time)
          .fontSize(14)
          .fontColor('#007AFF')
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .margin({ bottom: 12 })
    .shadow({
      radius: 4,
      color: '#1A000000',
      offsetX: 0,
      offsetY: 2
    })
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('æˆ‘çš„è¯¾ç¨‹è¡¨')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
        
        Blank()
        
        Text(this.getDayName(this.selectedDay))
          .fontSize(16)
          .fontColor('#FFFFFF')
      }
      .width('100%')
      .height(60)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#007AFF')
      .alignItems(VerticalAlign.Center)

      Column() {
        // æ˜ŸæœŸé€‰æ‹©æ 
        Row() {
          this.TabBuilder(1, 'å‘¨ä¸€')
          this.TabBuilder(2, 'å‘¨äºŒ')
          this.TabBuilder(3, 'å‘¨ä¸‰')
          this.TabBuilder(4, 'å‘¨å››')
          this.TabBuilder(5, 'å‘¨äº”')
          this.TabBuilder(6, 'å‘¨å…­')
          this.TabBuilder(7, 'å‘¨æ—¥')
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceAround)
        .margin({ top: 20, bottom: 20 })

        // åœ¨buildæ–¹æ³•ä¸­çš„ç»Ÿè®¡ä¿¡æ¯éƒ¨åˆ†ï¼Œä¿®æ”¹ä¸ºï¼š
        // ç»Ÿè®¡ä¿¡æ¯
        Row() {
          Column() {
            Text(this.getSelectedDayCourseCount().toString())
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#007AFF')
            Text('ä»Šæ—¥è¯¾ç¨‹')
              .fontSize(12)
              .fontColor('#999999')
              .margin({ top: 4 })
          }
          .justifyContent(FlexAlign.Center)
          
          Column() {
            Text(this.getFavoriteCourseCount().toString())
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF3B30')
            Text('æ”¶è—è¯¾ç¨‹')
              .fontSize(12)
              .fontColor('#999999')
              .margin({ top: 4 })
          }
          .justifyContent(FlexAlign.Center)
          
          Column() {
            Text(this.getSelectedDayTotalMinutes().toString())
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#34C759')
            Text('æ€»åˆ†é’Ÿ')
              .fontSize(12)
              .fontColor('#999999')
              .margin({ top: 4 })
          }
          .justifyContent(FlexAlign.Center)
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceAround)
        .margin({ bottom: 30 })

        // è¯¾ç¨‹åˆ—è¡¨æˆ–ç©ºçŠ¶æ€
        if (this.courses.filter(course => course.day === this.selectedDay).length === 0) {
          this.EmptyState()
        } else {
          List() {
            ForEach(this.courses.filter(course => course.day === this.selectedDay), (course: Course) => {
              ListItem() {
                this.CourseCard(course)
              }
            })
          }
          .width('100%')
          .layoutWeight(1)
        }
      }
      .width('100%')
      .layoutWeight(1)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
  }
}